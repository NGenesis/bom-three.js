THREE.BOMLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.BOMLoader.prototype={constructor:THREE.BOMLoader,load:function(e,t,s,r){var a=this;this.defaultTexturePath=e.split("/").slice(0,-1).join("/")+"/";var i=THREE.FileLoader?new THREE.FileLoader(this.manager):new THREE.XHRLoader(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.load(e,function(e){t(a.parse(e))},s,r)},setPath:function(e){this.path=e},setTexturePath:function(e){this.texturePath=e},setCrossOrigin:function(e){this.crossOrigin=e},setDebug:function(e){this.debug=e},setPerfTimer:function(e){this.performanceTimer=e},setResponseType:function(e){this.responseType=e},parse:function(e){function t(){var e=h.getUint8(g);return g+=Uint8Array.BYTES_PER_ELEMENT,e}function s(){var e=h.getUint16(g,!0);return g+=Uint16Array.BYTES_PER_ELEMENT,e}function r(){var e=h.getUint32(g,!0);return g+=Uint32Array.BYTES_PER_ELEMENT,e}function a(){var e=h.getFloat32(g,!0);return g+=Float32Array.BYTES_PER_ELEMENT,e}function i(e){var t=String.fromCharCode.apply(null,e>0?new Uint8Array(h.buffer,g,e):new Uint8Array);return g+=Uint8Array.BYTES_PER_ELEMENT*e,t}function n(e){if(0===g%Uint16Array.BYTES_PER_ELEMENT){var t=new Uint16Array(h.buffer,g,e);return g+=Uint16Array.BYTES_PER_ELEMENT*e,t}for(var t=new Uint16Array(e),s=0;e>s;++s,g+=Uint16Array.BYTES_PER_ELEMENT)t[s]=h.getUint16(g,!0);return t}function o(e){if(0===g%Float32Array.BYTES_PER_ELEMENT){var t=new Float32Array(h.buffer,g,e);return g+=Float32Array.BYTES_PER_ELEMENT*e,t}for(var t=new Float32Array(e),s=0;e>s;++s,g+=Float32Array.BYTES_PER_ELEMENT)t[s]=h.getFloat32(g,!0);return t}function E(e){if("string"!=typeof e||""===e)return"";if(/^https?:\/\//i.test(e))return e;var t=new URL((R.texturePath||R.path||R.defaultTexturePath||"")+e,location.href.substring(0,location.href.lastIndexOf("/")+1));return""+t}function l(e){e=E(e);var t;if(altspace&&altspace.inClient)t=new THREE.Texture({src:e});else{var s=THREE.Loader.Handlers.get(e);null===s&&(s=new THREE.TextureLoader(R.manager)),s.setCrossOrigin(R.crossOrigin),t=s.load(e)}return t.side=THREE.FrontSide,t.wrapS=t.wrapT=THREE.RepeatWrapping,t}this.performanceTimer&&console.time("BOMLoader");var u={NONE:0,FRONT:1,BACK:2,ALL:3},T={NONE:1,MATERIAL_LIBRARY:2},A={NONE:1,NAME:2},f={NONE:1,NAME:2,INDEX:4,SMOOTHING:8,MATERIAL:16},M={NONE:1,GEOMETRY:2},p={NONE:1,NORMAL:2,UV1:4,UV2:8},c={NONE:1,ILLUMINATION_MODEL:2,SPECULAR_EXPONENT:4,OPTICAL_DENSITY:8,DISSOLVE:16,TRANSMISSION_FILTER:32,AMBIENT_REFLECTANCE:64,DIFFUSE_REFLECTANCE:128,SPECULAR_REFLECTANCE:256,EMISSIVE_REFLECTANCE:512,AMBIENT_MAP:1024,DIFFUSE_MAP:2048,SPECULAR_MAP:4096,EMISSIVE_MAP:8192,DISSOLVE_MAP:16384,BUMP_MAP:32768,DISPLACEMENT_MAP:65536,FACE_CULLING:1<<17,LIGHT_MAP:1<<18},d={NONE:1,PATH:2,SCALE:4,OFFSET:8,BUMP_SCALE:16,DISPLACEMENT_SCALE:32,LIGHTMAP_INTENSITY:64},h=new DataView(e),g=0,L="array"===this.responseType,S=L?[]:new THREE.Group,R=this,N=i(3);this.debug&&console.log("File Signature",N);var P=t();this.debug&&console.log("Version",P);var m=s();this.debug&&console.log("FileAttributes:","\n","Material Library",x&T.MATERIAL_LIBRARY?!0:!1);var I=[];if(m&T.MATERIAL_LIBRARY){var v=s();this.debug&&console.log("Material Count",v);for(var O=0;v>O;++O){var b=r();this.debug&&console.log("MaterialAttributes:","\n","Illumination Model",b&c.ILLUMINATION_MODEL?!0:!1,"\n","Specular Exponent",b&c.SPECULAR_EXPONENT?!0:!1,"\n","Optical Density",b&c.OPTICAL_DENSITY?!0:!1,"\n","Dissolve",b&c.DISSOLVE?!0:!1,"\n","Transmission Filter",b&c.TRANSMISSION_FILTER?!0:!1,"\n","Ambient Reflectance",b&c.AMBIENT_REFLECTANCE?!0:!1,"\n","Diffuse Reflectance",b&c.DIFFUSE_REFLECTANCE?!0:!1,"\n","Specular Reflectance",b&c.SPECULAR_REFLECTANCE?!0:!1,"\n","Ambient Map",b&c.AMBIENT_MAP?!0:!1,"\n","Diffuse Map",b&c.DIFFUSE_MAP?!0:!1,"\n","Specular Map",b&c.SPECULAR_MAP?!0:!1,"\n","Dissolve Map",b&c.DISSOLVE_MAP?!0:!1,"\n","Bump Map",b&c.BUMP_MAP?!0:!1,"\n","Displacement Map",b&c.DISPLACEMENT_MAP?!0:!1,"\n","Face Culling",b&c.FACE_CULLING?!0:!1,"\n","Light Map",b&c.LIGHT_MAP?!0:!1);var _={};if(_.name=i(s()),this.debug&&console.log("Material Name",_.name),b&c.ILLUMINATION_MODEL&&t(),b&c.SPECULAR_EXPONENT&&(_.shininess=a(),this.debug&&console.log("Specular Exponent",_.shininess)),b&c.OPTICAL_DENSITY&&a(),b&c.DISSOLVE&&(_.opacity=a(),_.transparent=!0,this.debug&&console.log("Dissolve",_.opacity)),b&c.TRANSMISSION_FILTER&&(a(),a(),a()),b&c.AMBIENT_REFLECTANCE&&(a(),a(),a()),b&c.DIFFUSE_REFLECTANCE&&(_.color=new THREE.Color(a(),a(),a()),this.debug&&console.log("Diffuse Reflectance",_.color)),b&c.SPECULAR_REFLECTANCE&&(_.specular=new THREE.Color(a(),a(),a()),this.debug&&console.log("Specular Reflectance",_.specular)),b&c.EMISSIVE_REFLECTANCE&&(_.emissive=new THREE.Color(a(),a(),a()),this.debug&&console.log("Emissive Reflectance",_.emissive)),b&c.AMBIENT_MAP){var C=s();C&d.PATH&&i(s()),C&d.SCALE&&(a(),a()),C&d.OFFSET&&(a(),a())}if(b&c.DIFFUSE_MAP){var C=s(),F=l(C&d.PATH?i(s()):"");C&d.SCALE&&F.repeat.set(a(),a()),C&d.OFFSET&&F.offset.set(a(),a()),_.map=F,this.debug&&C&d.PATH&&console.log("Diffuse Map",F)}if(b&c.SPECULAR_MAP){var C=s(),F=l(C&d.PATH?i(s()):"");C&d.SCALE&&F.repeat.set(a(),a()),C&d.OFFSET&&F.offset.set(a(),a()),_.specularMap=F}if(b&c.EMISSIVE_MAP){var C=s(),F=l(C&d.PATH?i(s()):"");C&d.SCALE&&F.repeat.set(a(),a()),C&d.OFFSET&&F.offset.set(a(),a()),_.emissiveMap=F}if(b&c.DISSOLVE_MAP){var C=s(),F=l(C&d.PATH?i(s()):"");C&d.SCALE&&F.repeat.set(a(),a()),C&d.OFFSET&&F.offset.set(a(),a()),_.alphaMap=F,_.transparent=!0}if(b&c.BUMP_MAP){var C=s(),F=l(C&d.PATH?i(s()):"");C&d.SCALE&&F.repeat.set(a(),a()),C&d.OFFSET&&F.offset.set(a(),a()),C&d.BUMP_SCALE&&(_.bumpScale=a()),_.bumpMap=F}if(b&c.DISPLACEMENT_MAP){var C=s(),F=l(C&d.PATH?i(s()):"");C&d.SCALE&&F.repeat.set(a(),a()),C&d.OFFSET&&F.offset.set(a(),a()),C&d.DISPLACEMENT_SCALE&&(_.displacementScale=a()),_.displacementMap=F}if(b&c.FACE_CULLING){var H=t();H===u.ALL?_.visible=!1:_.side=H===u.FRONT?THREE.BackSide:H===u.BACK?THREE.FrontSide:THREE.DoubleSide}if(b&c.LIGHT_MAP){var C=s(),F=l(C&d.PATH?i(s()):"");C&d.SCALE&&F.repeat.set(a(),a()),C&d.OFFSET&&F.offset.set(a(),a()),C&d.LIGHTMAP_INTENSITY&&(_.lightMapIntensity=a()),_.lightMap=F}var y=new THREE.MeshPhongMaterial(_);I.push(y)}}var U=s();this.debug&&console.log("Asset Count",U);for(var B=0;U>B;++B){var D=s();this.debug&&console.log("AssetAttributes:","\n","Name",D&A.NAME?!0:!1);var w=S;if(L&&(w=new THREE.Group,S.push(w)),D&A.NAME){var G=i(s());this.debug&&console.log("Asset Name",G),L||(w.name=G)}var Y=s();this.debug&&console.log("Object Count",Y);for(var O=0;Y>O;++O){var x=s();this.debug&&console.log("ObjectAttributes:","\n","Geometry",x&M.GEOMETRY?!0:!1);var V={};if(x&M.GEOMETRY){var j=s();this.debug&&console.log("GeometryAttributes:","\n","Normal",j&p.NORMAL?!0:!1,"\n","UV1",j&p.UV1?!0:!1,"\n","UV2",j&p.UV2?!0:!1);var X=r();this.debug&&console.log("Vertex Count",X),V.positions=o(3*X),j&p.NORMAL&&(V.normals=o(3*X)),j&p.UV1&&(V.uvs=o(2*X)),j&p.UV2&&(V.uvs2=o(2*X))}var K=s();this.debug&&console.log("Group Count",K);for(var k=0;K>k;++k){var W=s();this.debug&&console.log("GroupAttributes:","\n","Index",W&f.INDEX?!0:!1,"\n","Smoothing",W&f.SMOOTHING?!0:!1,"\n","Material",W&f.MATERIAL?!0:!1);var q;if(W&f.NAME&&(q=i(s()),this.debug&&console.log("Group Name",q)),x&M.GEOMETRY){var z;if(W&f.INDEX){var J=r();this.debug&&console.log("Index Count",J),z=n(J)}var Q=W&f.SMOOTHING?t():0;this.debug&&W&f.SMOOTHING&&console.log("Smoothing",Q);var Z=new THREE.BufferGeometry;V.positions&&Z.addAttribute("position",new THREE.BufferAttribute(V.positions,3)),V.normals?Z.addAttribute("normal",new THREE.BufferAttribute(V.normals,3)):Z.computeVertexNormals(),V.uvs&&Z.addAttribute("uv",new THREE.BufferAttribute(V.uvs,2)),V.uvs2&&Z.addAttribute("uv2",new THREE.BufferAttribute(V.uvs2,2)),z&&Z.setIndex(new THREE.BufferAttribute(z,1)),Z.addGroup(0,1,0);var y;if(W&f.MATERIAL){var $=s();y=I[$].clone()||new THREE.MeshPhongMaterial,void 0!==y.flatShading?y.flatShading=0>=Q:y.shading=Q>0?THREE.SmoothShading:THREE.FlatShading,this.debug&&console.log("Group Material",$,y)}var et=new THREE.Mesh(Z,y);q&&(et.name=q),w.add(et)}}}}return this.performanceTimer&&console.timeEnd("BOMLoader"),S}},THREE.BOMLoaderUtil=THREE.BOMLoaderUtil||{},THREE.BOMLoaderUtil.multiload=function(e,t){function s(e,s){var i=new THREE.BOMLoader;i.setTexturePath(s.url.split("/").slice(0,-1).join("/")+"/"),void 0!==s.debug&&i.setDebug(s.debug),void 0!==s.timer&&i.setPerfTimer(s.timer),void 0!==s.crossOrigin&&i.setCrossOrigin(s.crossOrigin),void 0!==s.responseType&&i.setResponseType(s.responseType),i.load(s.url,function(i){s.object=i,a[e]=s,0>=--r&&t(a)})}e=e.constructor===Array?e:[e];for(var r=e.length,a=[],i=0;e.length>i;++i)s(i,e[i])},AFRAME.registerSystem("bom-assets",{init:function(){this.assets=[]},registerAsset:function(e){this.assets.push(e)},unregisterAsset:function(e){var t=this.assets.indexOf(e);t>=0&&this.assets.splice(t,1)}}),AFRAME.registerComponent("bom-asset",{schema:{src:{type:"string"},crossOrigin:{type:"string","default":"anonymous"},debug:{type:"boolean","default":!1},perfTimer:{type:"boolean","default":!1},responseType:{type:"string","default":""},path:{type:"string"},texturePath:{type:"string"}},init:function(){this.asset=null,this.loader=new THREE.BOMLoader},update:function(){var e=this;this.data.src&&(this.remove(),this.loader.setCrossOrigin(this.data.crossOrigin),this.loader.setDebug(this.data.debug),this.loader.setPerfTimer(this.data.perfTimer),this.loader.setResponseType(this.data.responseType),this.loader.setPath(this.data.path),this.loader.setTexturePath(this.data.texturePath),this.loader.load(this.data.src,function(t){e.asset=t,e.system&&e.system.registerModel(e.asset),e.el.setObject3D("mesh",e.asset),e.el.emit("model-loaded",{format:"bom",model:e.asset})}))},remove:function(){this.asset&&(this.el.removeObject3D("mesh"),this.system&&this.system.unregisterModel(this.asset))}}),AFRAME.registerPrimitive("a-bom-asset",{mappings:{src:"bom-asset.src",crossOrigin:"bom-asset.crossOrigin",debug:"bom-asset.debug",perfTimer:"bom-asset.perfTimer",responseType:"bom-asset.responseType",path:"bom-asset.path",texturePath:"bom-asset.texturePath"}});